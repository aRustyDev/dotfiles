# Top-level Claude Project Justfile
# This coordinates project-specific justfiles using a modular architecture

import '../.build/just/lib.just'

# Configurable defaults - change these to work on different projects
CATEGORY := env("CLAUDE_CATEGORY", "tree-sitter")
PROJECT := env("CLAUDE_PROJECT", "kvconf")

# Build the import path from the variables
import? 'build/{{CATEGORY}}/{{PROJECT}}/justfile'

# Optionally import category-level if it exists
import? 'build/{{CATEGORY}}/justfile'

# Default recipe - show available commands
default:
    @echo "Current project: {{CATEGORY}}/{{PROJECT}}"
    @echo ""
    @just --list

# Run a command for a specific project
run CATEGORY PROJECT *ARGS:
    @CLAUDE_CATEGORY={{CATEGORY}} CLAUDE_PROJECT={{PROJECT}} just {{ARGS}}

# Shorthand alias for current project commands
x *ARGS:
    @just {{ARGS}}

# Show current project settings
info:
    @echo "Category: {{CATEGORY}}"
    @echo "Project: {{PROJECT}}"
    @echo "Project justfile: build/{{CATEGORY}}/{{PROJECT}}/justfile"

# List all available projects
projects:
    @echo "Available projects:"
    @find build -name "justfile" -type f | sed 's|build/||g' | sed 's|/justfile||g' | sort

# Check for feedback updates in current project
check-feedback:
    #!/usr/bin/env bash
    set -euo pipefail
    FEEDBACK_DIR="feedback/{{CATEGORY}}/{{PROJECT}}"

    if [ ! -d "$FEEDBACK_DIR" ]; then
        echo "❌ Feedback directory not found: $FEEDBACK_DIR"
        exit 1
    fi

    echo "Checking feedback for {{CATEGORY}}/{{PROJECT}}..."

    # Find pending feedback
    PENDING=$(grep -r "Status: Pending" "$FEEDBACK_DIR" 2>/dev/null | wc -l | tr -d ' ')
    IN_PROGRESS=$(grep -r "Status: In Progress" "$FEEDBACK_DIR" 2>/dev/null | wc -l | tr -d ' ')

    if [ "$PENDING" -gt 0 ] || [ "$IN_PROGRESS" -gt 0 ]; then
        echo "📝 Active feedback found:"
        [ "$PENDING" -gt 0 ] && echo "  - Pending: $PENDING items"
        [ "$IN_PROGRESS" -gt 0 ] && echo "  - In Progress: $IN_PROGRESS items"
        echo ""
        echo "Files with active feedback:"
        grep -l "Status: Pending\|Status: In Progress" "$FEEDBACK_DIR"/*.md 2>/dev/null || true
    else
        echo "✅ No active feedback items"
    fi
