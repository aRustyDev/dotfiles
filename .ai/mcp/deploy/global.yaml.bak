---
# docker-compose.yml
name: mcp-global

services:
  traefik:
    image: traefik:latest
    container_name: ingress
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
  dockerhub:
    image: mcp/dockerhub
    container_name: dockerhub
    stdin_open: true # docker run -i
    tty: true # docker run -t
    command:
      - "--transport=stdio"
      - "--username=op://Cisco/koclujb733w4wcgafe4whlurwa/username"
    environment:
      HUB_PAT_TOKEN: "op://Cisco/koclujb733w4wcgafe4whlurwa/credential"
    labels:
      traefik.enable: true
      traefik.http.routers.dockerhub.rule: PathPrefix(`/dockerhub`)
      traefik.http.routers.dockerhub.loadbalancer.server.port: 3000
  github:
    image: ghcr.io/github/github-mcp-server
    container_name: github
    stdin_open: true # docker run -i
    tty: true # docker run -t
    labels:
      traefik.enable: true
      traefik.http.routers.github.rule: PathPrefix(`/github`)
    environment:
      GITLAB_API_URL: https://gitlab.com/api/v4
      GITHUB_PERSONAL_ACCESS_TOKEN: "op://Developer/zed-github-mcp/token"
  falkordb:
    image: falkordb/falkordb:latest
    container_name: graphdb
    ports:
      - "6379:6379" # Redis/FalkorDB port
      - "3000:3000" # FalkorDB web UI
    environment:
      - FALKORDB_PASSWORD=${FALKORDB_PASSWORD:-}
      - BROWSER=${BROWSER:-1} # Enable FalkorDB Browser UI (set to 0 to disable)
    volumes:
      - ${XDG_DATA_HOME:-$HOME/.local/share}/mcp/memory:/data # Persist FalkorDB data
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    labels:
      traefik.enable: true
      # FalkorDB UI Access - Use subdomain to avoid path prefix issues with Next.js assets
      traefik.http.services.falkorui.loadbalancer.server.port: 3000
      traefik.http.routers.falkorui.rule: Host(`falkor.ui.localhost`)
      traefik.http.routers.falkorui.service: falkorui
      traefik.http.routers.falkorui.entrypoints: web
      # FalkorDB Access
      traefik.http.services.falkordb.loadbalancer.server.port: 6379
      traefik.http.routers.falkordb.rule: Host(`db.localhost`) && PathPrefix(`/graph`)
      traefik.http.routers.falkordb.service: falkordb
      traefik.http.routers.falkordb.entrypoints: web
  memory:
    image: zepai/knowledge-graph-mcp:standalone
    container_name: memory
    restart: unless-stopped
    stdin_open: true # docker run -i
    tty: true # docker run -t
    # For specific versions, replace 'standalone' with a version tag:
    #   image: zepai/knowledge-graph-mcp:1.0.0-standalone
    # When building locally, the build section below will be used.
    env_file:
      - path: ./config/graphiti.env
        required: false
    depends_on:
      falkordb:
        condition: service_healthy
      ollama-cpu:
        condition: service_healthy
      ollama-pull-models:
        condition: service_completed_successfully
    environment:
      # Database configuration
      - FALKORDB_URI=${FALKORDB_URI:-redis://falkordb:6379}
      - FALKORDB_PASSWORD=${FALKORDB_PASSWORD:-}
      - FALKORDB_DATABASE=${FALKORDB_DATABASE:-default_db}
      # Application configuration
      - GRAPHITI_GROUP_ID=${GRAPHITI_GROUP_ID:-main}
      - SEMAPHORE_LIMIT=${SEMAPHORE_LIMIT:-10}
      - CONFIG_PATH=/app/mcp/config/config.yaml
      - PATH=/root/.local/bin:${PATH}
      # Workaround for cross-encoder initialization
      - OPENAI_API_KEY=ollama
      - OPENAI_API_BASE=http://ollama:11434/v1
    configs:
      - source: graphiti
        target: /app/mcp/config/config.yaml
    ports:
      - "8000:8000" # Expose the MCP server via HTTP transport
    command: ["uv", "run", "main.py"]
    labels:
      traefik.enable: true
      traefik.http.services.memory.loadbalancer.server.port: 8000
      traefik.http.routers.memory-mcp.rule: Host(`mcp.localhost`) && PathPrefix(`/memory`)
      traefik.http.routers.memory-mcp.service: memory
      traefik.http.routers.memory-mcp.entrypoints: web
      traefik.http.middlewares.strip-memory.stripprefix.prefixes: /memory
      traefik.http.routers.memory-mcp.middlewares: strip-memory

  sequentialthinking:
    image: mcp/sequentialthinking
    container_name: thinking
    stdin_open: true # docker run -i
    tty: true # docker run -t
    # NOTE: Sequential Thinking runs on stdio, not HTTP
    # Access via thinking-http wrapper service below for HTTP/Traefik routing
    # Or use: docker exec -i thinking node dist/index.js

  thinking-http:
    image: node:20-alpine
    container_name: thinking-http
    restart: unless-stopped
    command: >
      sh -c "npm install -g mcp-proxy &&
             mcp-proxy
               --host 0.0.0.0
               --port 8080
               --stateless
               docker exec -i thinking node dist/index.js"
    ports:
      - "9001:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      traefik.enable: true
      traefik.http.services.thinking.loadbalancer.server.port: 8080
      traefik.http.routers.thinking.rule: Host(`thinking.localhost`)
      traefik.http.routers.thinking.service: thinking
      traefik.http.routers.thinking.entrypoints: web
      traefik.http.services.thinking-http.loadbalancer.server.port: 8080
      traefik.http.routers.thinking-http.rule: Host(`mcp.localhost`) && PathPrefix(`/plan/seq`)
      traefik.http.routers.thinking-http.service: thinking-http
      traefik.http.routers.thinking-http.entrypoints: web
      traefik.http.middlewares.strip-planseq.stripprefix.prefixes: /plan/seq
      traefik.http.routers.thinking-http.middlewares: strip-planseq
    depends_on:
      sequentialthinking:
        condition: service_healthy
    #   traefik.http.routers.sequentialthinking.service: sequentialthinking
    #   traefik.http.routers.sequentialthinking.entrypoints: web
    #   traefik.http.middlewares.strip-plan.stripprefix.prefixes: /plan
    #   traefik.http.middlewares.strip-seq.stripprefix.prefixes: /seq
    #   traefik.http.routers.memory-mcp.middlewares: strip-plan,strip-seq
    # NOTE: Sequential Thinking runs on stdio, not HTTP
    # It cannot be accessed via Traefik - use stdio transport instead
    # labels:
    #   traefik.enable: true
    #   traefik.http.routers.sequentialthinking.rule: PathPrefix(`/plan/seq`)
  duckduckgo:
    image: mcp/duckduckgo
    container_name: websearch
    stdin_open: true # docker run -i
    tty: true # docker run -t
    labels:
      traefik.enable: true
      traefik.http.routers.duckduckgo.rule: PathPrefix(`/search/ddg`)
    annotations:
      com.example.foo: bar
  gitlab:
    image: mcp/gitlab
    stdin_open: true # docker run -i
    tty: true # docker run -t
    container_name: gitlab
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gitlab.rule=PathPrefix(`/gitlab`)"
    environment:
      GITLAB_PERSONAL_ACCESS_TOKEN: "op://Developer/zed-mcp-gitlab/credential"
  gitlab-sscm:
    image: mcp/gitlab
    stdin_open: true # docker run -i
    tty: true # docker run -t
    container_name: SSCM
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gitlab.rule=PathPrefix(`/cisco/sscm`)"
    environment:
      GITLAB_API_URL: https://sscm.gus.cisco.com/api/v4
      GITLAB_PERSONAL_ACCESS_TOKEN: "op://Cisco/2aesy5on3cb6z6opqieeautagi/token"
  ollama-cpu:
    image: ollama/ollama:latest
    container_name: ollama
    networks: ["global"]
    restart: unless-stopped
    ports:
      - 11434:11434
    volumes:
      - $HOME/.local/share/mcp/ollama:/root/.ollama
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "bash",
          "-c",
          "'cat < /dev/null > /dev/tcp/localhost/11434'",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
  ollama-pull-models:
    image: ollama/ollama:latest
    stdin_open: true # docker run -i
    tty: true # docker run -t
    networks: ["global"]
    container_name: ollama-pull-models
    volumes:
      - $HOME/.local/share/mcp/ollama:/root/.ollama
    entrypoint: /bin/sh
    environment:
      - OLLAMA_HOST=ollama:11434
    command:
      - "-c"
      - "sleep 3; ollama pull llama3.2 && ollama pull nomic-embed-text"
    depends_on:
      ollama-cpu:
        condition: service_healthy
  time:
    image: mcp/time
    container_name: tool-time
    stdin_open: true # docker run -i
    tty: true # docker run -t
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.time.rule=PathPrefix(`/time`)"
  simplechecklist:
    # https://github.com/DevMayur/SimpleCheckList
    image: mayurkakade/mcp-server:latest
    container_name: checklists
    stdin_open: true # docker run -i
    tty: true # docker run -t
    restart: unless-stopped
    ports:
      - "8355:8355"
      - "8180:80"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.github.rule=PathPrefix(`/plan/checklist`)"
    volumes:
      - "$HOME/.local/share/mcp/checklist/global:/data"
    environment:
      API_BASE_URL: http://localhost:8355/
      DATABASE_PATH: /data/checklist.db
  # aws-core:
  #   image: mcp/aws-core-mcp-server
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.github.rule=PathPrefix(`/github`)"
  # aws-diagram:
  #   image: mcp/aws-diagram
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.github.rule=PathPrefix(`/github`)"
  # aws-terraform:
  #   image: mcp/aws-terraform
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.github.rule=PathPrefix(`/github`)"
  # aws-api:
  #   image: mcp/aws-api-mcp-server
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.github.rule=PathPrefix(`/github`)"
  # aws-docs:
  #   image: mcp/aws-documentation
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.github.rule=PathPrefix(`/github`)"
  # aws-cloudtrail:
  #   image: mcp/cloudtrail-mcp-server
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.github.rule=PathPrefix(`/github`)"
  # python-refactoring:
  #   image: mcp/mcp-python-refactoring
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.pyref.rule=PathPrefix(`/py/refactor`)"
  # prometheus:
  #   image: ghcr.io/pab1it0/prometheus-mcp-server
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.github.rule=PathPrefix(`/github`)"
  # terraform:
  #   image: hashicorp/terraform-mcp-server
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.terraform.rule=PathPrefix(`/terraform`)"

networks:
  global:

configs:
  graphiti:
    file: ./config/graphiti.yaml
