# =============================================================================
# PostgreSQL Exporter - Custom Queries
# =============================================================================
# Additional metrics queries for PostgreSQL monitoring.
# These supplement the default metrics with application-specific insights.
# =============================================================================

pg_replication:
  query: |
    SELECT
      CASE WHEN pg_is_in_recovery() THEN 1 ELSE 0 END AS is_replica,
      COALESCE(EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp()))::INT, 0) AS lag_seconds
  master: true
  metrics:
    - is_replica:
        usage: "GAUGE"
        description: "Indicates if this server is a replica (1) or primary (0)"
    - lag_seconds:
        usage: "GAUGE"
        description: "Replication lag in seconds"

pg_database_size:
  query: |
    SELECT
      datname AS database,
      pg_database_size(datname) AS size_bytes
    FROM pg_database
    WHERE datistemplate = false
  master: true
  metrics:
    - database:
        usage: "LABEL"
        description: "Database name"
    - size_bytes:
        usage: "GAUGE"
        description: "Database size in bytes"

pg_stat_user_tables:
  query: |
    SELECT
      schemaname,
      relname AS table,
      seq_scan,
      seq_tup_read,
      idx_scan,
      idx_tup_fetch,
      n_tup_ins,
      n_tup_upd,
      n_tup_del,
      n_live_tup,
      n_dead_tup,
      COALESCE(last_vacuum, '1970-01-01'::timestamp) AS last_vacuum,
      COALESCE(last_autovacuum, '1970-01-01'::timestamp) AS last_autovacuum,
      COALESCE(last_analyze, '1970-01-01'::timestamp) AS last_analyze,
      COALESCE(last_autoanalyze, '1970-01-01'::timestamp) AS last_autoanalyze
    FROM pg_stat_user_tables
  master: true
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Schema name"
    - table:
        usage: "LABEL"
        description: "Table name"
    - seq_scan:
        usage: "COUNTER"
        description: "Number of sequential scans"
    - seq_tup_read:
        usage: "COUNTER"
        description: "Tuples read by sequential scans"
    - idx_scan:
        usage: "COUNTER"
        description: "Number of index scans"
    - idx_tup_fetch:
        usage: "COUNTER"
        description: "Tuples fetched by index scans"
    - n_tup_ins:
        usage: "COUNTER"
        description: "Tuples inserted"
    - n_tup_upd:
        usage: "COUNTER"
        description: "Tuples updated"
    - n_tup_del:
        usage: "COUNTER"
        description: "Tuples deleted"
    - n_live_tup:
        usage: "GAUGE"
        description: "Estimated live tuples"
    - n_dead_tup:
        usage: "GAUGE"
        description: "Estimated dead tuples"

pg_locks:
  query: |
    SELECT
      pg_database.datname AS database,
      mode,
      COUNT(*) AS count
    FROM pg_locks
    JOIN pg_database ON pg_locks.database = pg_database.oid
    GROUP BY pg_database.datname, mode
  master: true
  metrics:
    - database:
        usage: "LABEL"
        description: "Database name"
    - mode:
        usage: "LABEL"
        description: "Lock mode"
    - count:
        usage: "GAUGE"
        description: "Number of locks"

pg_stat_activity_state:
  query: |
    SELECT
      datname AS database,
      state,
      COUNT(*) AS count
    FROM pg_stat_activity
    WHERE datname IS NOT NULL
    GROUP BY datname, state
  master: true
  metrics:
    - database:
        usage: "LABEL"
        description: "Database name"
    - state:
        usage: "LABEL"
        description: "Connection state"
    - count:
        usage: "GAUGE"
        description: "Number of connections in this state"

pg_slow_queries:
  query: |
    SELECT
      datname AS database,
      COUNT(*) AS count
    FROM pg_stat_activity
    WHERE state = 'active'
      AND now() - query_start > interval '5 seconds'
      AND query NOT LIKE '%pg_stat_activity%'
    GROUP BY datname
  master: true
  metrics:
    - database:
        usage: "LABEL"
        description: "Database name"
    - count:
        usage: "GAUGE"
        description: "Number of queries running longer than 5 seconds"
