# =============================================================================
# Graphiti MCP Server - Traefik Routing Configuration
# =============================================================================
# Multi-layer routing with parentRefs (Traefik v3.6+)
#
# Routing hierarchy:
#   memory@file (root)   -> Host(`memory.localhost`)
#     └── mcp@file       -> PathPrefix(`/mcp`)
#           └── graphiti -> Header(`X-Service`, `graphiti`) [THIS FILE]
#
# Container: memory (zepai/knowledge-graph-mcp:standalone)
#   - MCP endpoint: port 8000
#
# Access via:
#   npx -y mcp-remote https://memory.localhost/mcp --header "X-Service: graphiti"
# =============================================================================

http:
  routers:
    # Leaf router for Graphiti MCP server
    # Matches: Host(memory.localhost) && PathPrefix(/mcp) && Header(X-Service: graphiti)
    graphiti:
      rule: "Header(`X-Service`, `graphiti`)"
      service: graphiti-mcp
      parentRefs:
        - mcp@file
        - memory@file

    # Health check router
    # Matches: Host(memory.localhost) && PathPrefix(/health) && Header(X-Service: graphiti)
    graphiti-health:
      rule: "Header(`X-Service`, `graphiti`)"
      service: graphiti-mcp
      parentRefs:
        - health@file
        - memory@file

  services:
    graphiti-mcp:
      loadBalancer:
        servers:
          - url: "http://memory:8000"
