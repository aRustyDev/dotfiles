# =============================================================================
# Prometheus Configuration - With Remote Write to Mimir
# =============================================================================
# This configuration enables Prometheus to:
#   1. Scrape metrics from Docker containers and services
#   2. Forward all metrics to Mimir for long-term storage
#   3. Generate exemplars for trace correlation
#
# Remote Write:
#   - All scraped metrics are forwarded to Mimir
#   - Prometheus retains 15d locally (configured via CLI)
#   - Mimir provides long-term storage with efficient compression
#
# Service Discovery:
#   - Docker containers with prometheus labels
#   - Static configs for infrastructure services
# =============================================================================

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'docker-local'
    env: 'development'

# =============================================================================
# Remote Write - Forward All Metrics to Mimir
# =============================================================================
remote_write:
  - url: http://mimir:9009/api/v1/push
    send_exemplars: true
    queue_config:
      capacity: 10000
      max_shards: 5
      max_samples_per_send: 5000
      batch_send_deadline: 5s
    metadata_config:
      send: true
      send_interval: 1m

# =============================================================================
# Alerting Configuration
# =============================================================================
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

# =============================================================================
# Recording & Alerting Rules
# =============================================================================
rule_files:
  - /etc/prometheus/rules/*.yml

# =============================================================================
# Scrape Configurations
# =============================================================================
scrape_configs:
  # ---------------------------------------------------------------------------
  # Prometheus Self-Monitoring
  # ---------------------------------------------------------------------------
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'

  # ---------------------------------------------------------------------------
  # LGTM Stack Components
  # ---------------------------------------------------------------------------
  - job_name: 'lgtm-stack'
    static_configs:
      - targets: ['mimir:9009']
        labels:
          service: 'mimir'
      - targets: ['loki:3100']
        labels:
          service: 'loki'
      - targets: ['tempo:3200']
        labels:
          service: 'tempo'
      - targets: ['grafana:3000']
        labels:
          service: 'grafana'

  # ---------------------------------------------------------------------------
  # OpenTelemetry Collector
  # ---------------------------------------------------------------------------
  - job_name: 'otel-collector'
    static_configs:
      - targets: ['otel-collector:8888']
        labels:
          service: 'otel-collector'

  # ---------------------------------------------------------------------------
  # Infrastructure Services
  # ---------------------------------------------------------------------------
  - job_name: 'infrastructure'
    static_configs:
      - targets: ['traefik:8080']
        labels:
          service: 'traefik'

  # ---------------------------------------------------------------------------
  # Database Exporters
  # ---------------------------------------------------------------------------
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']
        labels:
          service: 'postgres'
          exporter: 'postgres-exporter'

  - job_name: 'mongodb'
    static_configs:
      - targets: ['mongodb-exporter:9216']
        labels:
          service: 'mongodb'
          exporter: 'mongodb-exporter'

  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
        labels:
          service: 'redis'
          exporter: 'redis-exporter'

  - job_name: 'valkey'
    static_configs:
      - targets: ['valkey-exporter:9121']
        labels:
          service: 'valkey'
          exporter: 'redis-exporter'

  - job_name: 'elasticsearch'
    static_configs:
      - targets: ['elasticsearch-exporter:9114']
        labels:
          service: 'elasticsearch'
          exporter: 'elasticsearch-exporter'

  # ---------------------------------------------------------------------------
  # Databases with Native Metrics
  # ---------------------------------------------------------------------------
  - job_name: 'qdrant'
    static_configs:
      - targets: ['qdrant:6333']
        labels:
          service: 'qdrant'
    metrics_path: '/metrics'

  - job_name: 'meilisearch'
    static_configs:
      - targets: ['meilisearch:7700']
        labels:
          service: 'meilisearch'
    metrics_path: '/metrics'

  - job_name: 'influxdb'
    static_configs:
      - targets: ['influxdb:8086']
        labels:
          service: 'influxdb'
    metrics_path: '/metrics'

  # ---------------------------------------------------------------------------
  # Authentication Services (ORY Stack)
  # ---------------------------------------------------------------------------
  - job_name: 'ory-hydra'
    static_configs:
      - targets: ['hydra:4445']
        labels:
          service: 'hydra'
          component: 'auth'
    metrics_path: '/admin/metrics/prometheus'

  - job_name: 'ory-kratos'
    static_configs:
      - targets: ['kratos:4434']
        labels:
          service: 'kratos'
          component: 'auth'
    metrics_path: '/admin/metrics/prometheus'

  - job_name: 'ory-oathkeeper'
    static_configs:
      - targets: ['oathkeeper:4456']
        labels:
          service: 'oathkeeper'
          component: 'auth'
    metrics_path: '/metrics'

  - job_name: 'ory-keto'
    static_configs:
      - targets: ['keto:4467']
        labels:
          service: 'keto'
          component: 'authz'
    metrics_path: '/metrics'

  # ---------------------------------------------------------------------------
  # Authorization Services
  # ---------------------------------------------------------------------------
  - job_name: 'spicedb'
    static_configs:
      - targets: ['spicedb:9090']
        labels:
          service: 'spicedb'
          component: 'authz'
    metrics_path: '/metrics'

  # ---------------------------------------------------------------------------
  # Docker Container Discovery
  # ---------------------------------------------------------------------------
  # Discovers containers with label: prometheus.scrape=true
  # ---------------------------------------------------------------------------
  - job_name: 'docker-containers'
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 30s
    relabel_configs:
      # Only scrape containers with prometheus.scrape=true label
      - source_labels: [__meta_docker_container_label_prometheus_scrape]
        regex: 'true'
        action: keep
      # Use container name as job name
      - source_labels: [__meta_docker_container_name]
        regex: '/(.+)'
        target_label: container
      # Use prometheus.port label for port, default to 80
      - source_labels: [__meta_docker_container_label_prometheus_port]
        regex: '(.+)'
        target_label: __address__
        replacement: '${1}'
      # Use prometheus.path for metrics path, default /metrics
      - source_labels: [__meta_docker_container_label_prometheus_path]
        regex: '(.+)'
        target_label: __metrics_path__
      # Add docker network labels
      - source_labels: [__meta_docker_network_name]
        target_label: docker_network
