# =============================================================================
# ORY Kratos Configuration
# =============================================================================
# Identity and user management configuration
#
# Documentation: https://www.ory.sh/docs/kratos/reference/configuration
# =============================================================================

version: v1.3.1

serve:
  public:
    base_url: https://id.localhost
    cors:
      enabled: true
      allowed_origins:
        - https://id.localhost
        - https://*.localhost
      allowed_methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      allowed_headers:
        - Authorization
        - Content-Type
        - Cookie
        - X-Session-Token
      exposed_headers:
        - Content-Type
        - Set-Cookie
      allow_credentials: true
      debug: false
  admin:
    base_url: http://kratos:4434

# Self-service flows
selfservice:
  default_browser_return_url: https://id.localhost/
  allowed_return_urls:
    - https://id.localhost
    - https://*.localhost

  methods:
    password:
      enabled: true
      config:
        haveibeenpwned_enabled: true
        min_password_length: 12
        identifier_similarity_check_enabled: true
    totp:
      enabled: true
      config:
        issuer: YourApp
    lookup_secret:
      enabled: true
    link:
      enabled: true
    code:
      enabled: true
      config:
        lifespan: 15m
    webauthn:
      enabled: true
      config:
        passwordless: true
        rp:
          id: localhost
          display_name: YourApp
          origins:
            - https://id.localhost
    profile:
      enabled: true
    oidc:
      enabled: false
      # config:
      #   providers:
      #     - id: github
      #       provider: github
      #       client_id: ${GITHUB_CLIENT_ID}
      #       client_secret: ${GITHUB_CLIENT_SECRET}
      #       mapper_url: file:///etc/kratos/schemas/oidc.github.jsonnet

  flows:
    error:
      ui_url: https://id.localhost/error

    settings:
      ui_url: https://id.localhost/settings
      privileged_session_max_age: 15m
      required_aal: highest_available

    recovery:
      enabled: true
      ui_url: https://id.localhost/recovery
      use: code
      lifespan: 1h
      notify_unknown_recipients: false

    verification:
      enabled: true
      ui_url: https://id.localhost/verification
      use: code
      lifespan: 1h
      notify_unknown_recipients: false
      after:
        default_browser_return_url: https://id.localhost/

    logout:
      after:
        default_browser_return_url: https://id.localhost/login

    login:
      ui_url: https://id.localhost/login
      lifespan: 10m
      after:
        password:
          hooks:
            - hook: require_verified_address
        oidc:
          hooks:
            - hook: require_verified_address

    registration:
      enabled: true
      ui_url: https://id.localhost/registration
      lifespan: 10m
      after:
        password:
          hooks:
            - hook: session
            - hook: show_verification_ui
        oidc:
          hooks:
            - hook: session

# Session configuration
session:
  lifespan: 24h
  cookie:
    name: ory_kratos_session
    persistent: true
    same_site: Lax

# Hashers
hashers:
  algorithm: bcrypt
  bcrypt:
    cost: 12

# Identity schemas
identity:
  default_schema_id: default
  schemas:
    - id: default
      url: file:///etc/kratos/schemas/identity.schema.json

# Courier (email) configuration
courier:
  smtp:
    # Connection URI set via environment variable
    from_address: noreply@localhost
    from_name: YourApp

  templates:
    recovery:
      valid:
        email:
          subject: Reset your password
          body:
            html: |
              <p>Hi,</p>
              <p>You requested to reset your password. Click the link below:</p>
              <p><a href="{{ .RecoveryURL }}">Reset Password</a></p>
              <p>If you didn't request this, please ignore this email.</p>
            plaintext: |
              Hi,

              You requested to reset your password. Visit the link below:
              {{ .RecoveryURL }}

              If you didn't request this, please ignore this email.
    verification:
      valid:
        email:
          subject: Verify your email address
          body:
            html: |
              <p>Hi,</p>
              <p>Please verify your email address by clicking the link below:</p>
              <p><a href="{{ .VerificationURL }}">Verify Email</a></p>
            plaintext: |
              Hi,

              Please verify your email address by visiting the link below:
              {{ .VerificationURL }}

# Logging
log:
  level: info
  format: json
  leak_sensitive_values: false

# Feature flags
feature_flags:
  use_continue_with_transitions: true
