# =============================================================================
# FileScopeMCP Server - Streamable HTTP
# =============================================================================
# Codebase analysis and visualization tool. Ranks files by importance based on
# dependency relationships, generates Mermaid diagrams, and allows AI assistants
# to understand and navigate code structure efficiently.
#
# Build: docker build -f files/filescope.dockerfile -t filescope-mcp:http .
# Image: filescope-mcp:http (wraps FileScopeMCP with supergateway)
#
# Usage in MCP clients (e.g., Zed):
#   {
#     "filescope": {
#       "url": "https://tool.localhost/mcp",
#       "headers": {
#         "X-Service": "filescope"
#       }
#     }
#   }
#
# Tools provided:
#
#   File Tree Management:
#     - list_saved_trees: List all saved file trees
#     - create_file_tree: Create new file tree for a directory
#     - select_file_tree: Select an existing file tree
#     - delete_file_tree: Delete a file tree configuration
#
#   File Analysis:
#     - list_files: List all files with importance rankings (0-10 scale)
#     - get_file_importance: Get detailed info including dependencies/dependents
#     - find_important_files: Find most critical files by configurable criteria
#     - read_file_content: Read content of a specific file
#     - recalculate_importance: Recalculate importance scores
#
#   File Summaries:
#     - get_file_summary: Get stored summary of a file
#     - set_file_summary: Set/update file summary (human or AI-generated)
#
#   File Watching:
#     - toggle_file_watching: Enable/disable file watching
#     - get_file_watching_status: Check file watching status
#     - update_file_watching_config: Configure watching behavior
#
#   Visualization:
#     - generate_diagram: Create Mermaid diagrams
#       - Formats: .mmd (text) or .html (rendered)
#       - Styles: default, dependency, directory, hybrid
#       - Options: depth, importance threshold, layout direction
#
# Supported Languages for Dependency Detection:
#   Python, JavaScript, TypeScript, C/C++, Rust, Lua, Zig, C#, Java
#
# Source: https://github.com/admica/FileScopeMCP
# =============================================================================
---
services:
  filescope:
    build:
      context: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/files
      dockerfile: filescope.dockerfile
    image: filescope-mcp:http
    container_name: filescope
    profiles: ["core", "project", "analysis"]
    restart: unless-stopped
    networks:
      - traefik-public
    expose:
      - "8080"
    volumes:
      # Mount your project/workspace directory for analysis
      # Change this to the directory you want to analyze
      - ${FILESCOPE_WORKSPACE:-${HOME}/projects}:/workspace:ro

      # Persistent storage for file trees, summaries, and diagrams
      - ${XDG_DATA_HOME:-$HOME/.local/share}/mcp/filescope:/app/data
    environment:
      # Supergateway settings
      PORT: 8080
      MCP_PATH: /mcp
      SESSION_TIMEOUT: 120000

      # Base directory for file analysis (inside container)
      BASE_DIR: "${FILESCOPE_BASE_DIR:-/workspace}"
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('net').connect(8080, 'localhost').on('error', () => process.exit(1)).on('connect', () => process.exit(0))",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      # =======================================================================
      # Traefik Configuration - Streamable HTTP MCP
      # =======================================================================
      # NOTE: Routing is defined in file provider (svc.mcp.filescope.yaml)
      # because parentRefs (multi-layer routing) is not supported in Docker labels.
      # =======================================================================
      traefik.enable: true
      traefik.docker.network: traefik-public

networks:
  traefik-public:
    external: true
