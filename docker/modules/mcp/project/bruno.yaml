# =============================================================================
# Bruno MCP Server - Streamable HTTP
# =============================================================================
# MCP server for running Bruno API test collections.
# Enables AI assistants to execute Bruno API tests and get detailed results.
#
# Build: docker build -f files/bruno.dockerfile -t bruno-mcp:http .
# Image: bruno-mcp:http (local build, wraps bruno-mcp with supergateway)
#
# Usage in MCP clients (e.g., Zed):
#   {
#     "bruno": {
#       "url": "https://tool.localhost/mcp",
#       "headers": {
#         "X-Service": "bruno"
#       }
#     }
#   }
#
# Tools provided:
#   - run-collection: Execute Bruno API test collections
#     Parameters:
#       - collection (required): Path to Bruno collection directory
#       - environment (optional): Environment file to use
#       - variables (optional): Runtime variables as key=value pairs
#
# Example usage:
#   Run collection: run-collection with collection="/collections/my-api"
#   With environment: run-collection with collection="/collections/my-api", environment="staging"
#   With variables: run-collection with collection="/collections/my-api", variables="apiKey=xxx,baseUrl=http://api.example.com"
#
# Collection mounting:
#   Mount your Bruno collections under /collections:
#   - /collections/project1
#   - /collections/project2
#
# Source: https://github.com/hungthai1401/bruno-mcp
# Bruno: https://www.usebruno.com/
# =============================================================================
---
services:
  bruno:
    build:
      context: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/files
      dockerfile: bruno.dockerfile
    image: bruno-mcp:http
    container_name: bruno
    profiles: ["core", "project", "testing"]
    restart: unless-stopped
    networks:
      - backend        # MCP backend services network
      - traefik-public # Legacy compatibility
    expose:
      - "8080"
    volumes:
      # Mount Bruno collections (read-only for safety during tests)
      # Add your collection paths here:
      # - /path/to/collections/project1:/collections/project1:ro
      # - /path/to/collections/project2:/collections/project2:ro
      - ${HOME}/repos:/collections/repos:ro
    environment:
      PORT: 8080
      MCP_PATH: /mcp
      SESSION_TIMEOUT: 60000
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 64M
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('net').connect(8080, 'localhost').on('error', () => process.exit(1)).on('connect', () => process.exit(0))",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    labels:
      # =======================================================================
      # Traefik Configuration - Streamable HTTP MCP
      # =======================================================================
      # NOTE: Routing is defined in file provider (svc.mcp.bruno.yaml)
      # because parentRefs (multi-layer routing) is not supported in Docker labels.
      # =======================================================================
      traefik.enable: true
      traefik.docker.network: backend

networks:
  backend:
    external: true
  traefik-public:
    external: true
