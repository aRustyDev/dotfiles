# NOTE: Requires falkordb and ollama services - start with:
#   COMPOSE_PROFILES=mcp-memory,db-graph,research-ml docker compose up -d graphiti
#
# Dependencies (must be running before graphiti):
#   - falkordb (db-graph profile)
#   - ollama + pull-models (research-ml profile)

services:
  graphiti:
    image: zepai/knowledge-graph-mcp:standalone
    profiles: ["mcp-memory", "mcp"]
    container_name: memory
    restart: unless-stopped
    stdin_open: true # docker run -i
    tty: true # docker run -t
    # For specific versions, replace 'standalone' with a version tag:
    #   image: zepai/knowledge-graph-mcp:1.0.0-standalone
    # When building locally, the build section below will be used.
    networks:
      - backend        # MCP backend services network
      - data-tier      # Access to FalkorDB
    env_file:
      - path: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/config/.env
        required: false
    environment:
      # Database configuration
      - FALKORDB_URI=${FALKORDB_URI:-redis://falkordb:6379}
      - FALKORDB_PASSWORD=${FALKORDB_PASSWORD:-}
      - FALKORDB_DATABASE=${FALKORDB_DATABASE:-default_db}
      # Application configuration
      - GRAPHITI_GROUP_ID=${GRAPHITI_GROUP_ID:-main}
      - SEMAPHORE_LIMIT=${SEMAPHORE_LIMIT:-10}
      - CONFIG_PATH=/app/graphiti.yaml
      - PATH=/root/.local/bin:${PATH}
      # Workaround for cross-encoder initialization
      - OPENAI_API_KEY=ollama
      - OPENAI_API_BASE=http://ollama:${OLLAMA_PORT:-11434}/v1
    configs:
      - source: graphiti
        target: /app/graphiti.yaml
    expose:
      - "8000"  # MCP server via HTTP transport - accessed via Traefik
    command: ["uv", "run", "main.py"]
    labels:
      # =======================================================================
      # Traefik Configuration - Streamable HTTP MCP
      # =======================================================================
      # NOTE: Routing is defined in file provider (svc.mcp.graphiti.yaml)
      # because parentRefs (multi-layer routing) is not supported in Docker labels.
      # =======================================================================
      traefik.enable: true
      traefik.docker.network: backend
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s

configs:
  graphiti:
    file: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/config/graphiti/config.yaml

