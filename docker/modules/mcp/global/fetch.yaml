# =============================================================================
# Fetch MCP Server - Streamable HTTP
# =============================================================================
# Web content fetching for LLMs and AI editors. Retrieves and converts web
# pages to markdown format for easy consumption by language models.
#
# Build: docker build -f files/fetch.dockerfile -t fetch-mcp:http .
# Image: fetch-mcp:http (local build, wraps mcp/fetch with supergateway)
#
# Usage in MCP clients (e.g., Zed):
#   {
#     "fetch": {
#       "url": "https://tool.localhost/mcp",
#       "headers": {
#         "X-Service": "fetch"
#       }
#     }
#   }
#
# Tools provided:
#   - fetch: Fetches a URL and returns content as markdown
#     Parameters:
#       - url: URL to fetch (required)
#       - max_length: Maximum content length (optional)
#       - start_index: Start position for pagination (optional)
#       - raw: Return raw content without markdown conversion (optional)
#
# Optional environment:
#   - USER_AGENT: Custom User-Agent string
#   - IGNORE_ROBOTS_TXT: Set to ignore robots.txt restrictions
#   - PROXY_URL: Proxy URL for requests
#
# Source: https://github.com/modelcontextprotocol/servers/tree/main/src/fetch
# Docker Hub: https://hub.docker.com/r/mcp/fetch
# =============================================================================
---
services:
  fetch:
    build:
      context: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/files
      dockerfile: fetch.dockerfile
    image: fetch-mcp:http
    container_name: fetch
    profiles: ["core", "web", "fetch"]
    restart: unless-stopped
    networks:
      - backend        # MCP backend services network
      - traefik-public # Legacy compatibility
    expose:
      - "8080"
    environment:
      PORT: 8080
      MCP_PATH: /mcp
      SESSION_TIMEOUT: 60000
      # USER_AGENT: "Custom User Agent"
      # IGNORE_ROBOTS_TXT: "true"
      # PROXY_URL: "http://proxy:8080"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('net').connect(8080, 'localhost').on('error', () => process.exit(1)).on('connect', () => process.exit(0))",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    labels:
      # =======================================================================
      # Traefik Configuration - Streamable HTTP MCP
      # =======================================================================
      # NOTE: Routing is defined in file provider (svc.mcp.fetch.yaml)
      # because parentRefs (multi-layer routing) is not supported in Docker labels.
      # =======================================================================
      traefik.enable: true
      traefik.docker.network: backend

networks:
  backend:
    external: true
  traefik-public:
    external: true
