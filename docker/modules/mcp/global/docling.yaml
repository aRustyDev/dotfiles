# =============================================================================
# Docling MCP Server - Streamable HTTP
# =============================================================================
# MCP server for document processing and PDF conversion using the Docling library.
# Converts documents to structured formats and enables document generation.
#
# Build: docker build -f files/docling.dockerfile -t docling-mcp:http .
# Image: docling-mcp:http (local build, wraps docling-mcp with supergateway)
#
# Usage in MCP clients (e.g., Zed):
#   {
#     "docling": {
#       "url": "https://tool.localhost/mcp",
#       "headers": {
#         "X-Service": "docling"
#       }
#     }
#   }
#
# Tools provided:
#   - convert_document: Transform PDF/documents to structured JSON (DoclingDocument)
#   - create_document: Create new DoclingDocument instances
#   - add_title: Add title to document
#   - add_section: Add section to document
#   - add_list: Add list to document
#   - export_to_markdown: Export document to Markdown format
#   - get_cached_document: Retrieve cached document
#   - list_cached_documents: List all cached documents
#
# Supported formats:
#   - PDF (primary)
#   - Local files and URLs as sources
#
# Features:
#   - Local document caching for performance
#   - RAG-ready (Milvus integration available)
#   - Multi-format export (Markdown, JSON)
#
# Source: https://github.com/docling-project/docling-mcp
# =============================================================================
---
services:
  docling:
    build:
      context: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/files
      dockerfile: docling.dockerfile
    image: docling-mcp:http
    container_name: docling
    profiles: ["core", "documents", "pdf"]
    restart: unless-stopped
    networks:
      - traefik-public
    ports:
      - "${DOCLING_MCP_HTTP_PORT:-8220}:8080"
    volumes:
      # Document storage and cache
      - ${XDG_DATA_HOME:-$HOME/.local/share}/mcp/docling/documents:/data/documents
      - ${XDG_CACHE_HOME:-$HOME/.cache}/mcp/docling:/data/cache
    environment:
      PORT: 8080
      MCP_PATH: /mcp
      SESSION_TIMEOUT: 60000
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('net').connect(8080, 'localhost').on('error', () => process.exit(1)).on('connect', () => process.exit(0))",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    labels:
      # =======================================================================
      # Traefik Configuration - Streamable HTTP MCP
      # =======================================================================
      # NOTE: Routing is defined in file provider (svc.mcp.docling.yaml)
      # because parentRefs (multi-layer routing) is not supported in Docker labels.
      # =======================================================================
      traefik.enable: true
      traefik.docker.network: traefik-public
