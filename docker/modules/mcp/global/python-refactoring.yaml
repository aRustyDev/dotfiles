# =============================================================================
# Python Refactoring MCP Server - Streamable HTTP
# =============================================================================
# MCP server for Python code refactoring using the Rope library.
# Provides automated refactoring capabilities for AI assistants.
#
# Build: docker build -f files/python-refactoring.dockerfile -t python-refactoring-mcp:http .
# Image: python-refactoring-mcp:http (local build, wraps rope-mcp with supergateway)
#
# Usage in MCP clients (e.g., Zed):
#   {
#     "python-refactoring": {
#       "url": "https://tool.localhost/mcp",
#       "headers": {
#         "X-Service": "python-refactoring"
#       }
#     }
#   }
#
# Tools provided (via Rope library):
#   - rename: Rename variables, functions, classes, modules
#   - extract_method: Extract code block into a new method
#   - extract_variable: Extract expression into a variable
#   - inline: Inline a variable or method
#   - move: Move classes/functions between modules
#   - change_signature: Modify function signatures
#   - organize_imports: Sort and organize import statements
#
# Workspace mounting:
#   Mount your Python project directories under /workspaces for refactoring:
#   - /workspaces/project1 (read-write for refactoring operations)
#   - /workspaces/project2
#
# Source: https://github.com/brukhabtu/rope-mcp
# Rope Library: https://github.com/python-rope/rope
# =============================================================================
---
services:
  python-refactoring:
    build:
      context: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/files
      dockerfile: python-refactoring.dockerfile
    image: python-refactoring-mcp:http
    container_name: python-refactoring
    hostname: python-refactoring
    profiles: ["mcp"]
    restart: unless-stopped
    networks:
      - backend        # MCP backend services network
    expose:
      - "8080"
    volumes:
      # Mount Python project directories for refactoring
      # NOTE: Read-write access required for refactoring operations
      # Add your Python project paths here:
      # - /path/to/project1:/workspaces/project1
      # - /path/to/project2:/workspaces/project2
      - ${HOME}/repos:/workspaces/repos
    environment:
      PORT: 8080
      MCP_PATH: /mcp
      SESSION_TIMEOUT: 60000
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 64M
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('net').connect(8080, 'localhost').on('error', () => process.exit(1)).on('connect', () => process.exit(0))",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    labels:
      # =======================================================================
      # Traefik Configuration - Streamable HTTP MCP
      # =======================================================================
      # NOTE: Routing is defined in file provider (svc.mcp.python-refactoring.yaml)
      # because parentRefs (multi-layer routing) is not supported in Docker labels.
      # =======================================================================
      traefik.enable: true
      traefik.docker.network: backend
      # Observability labels
      o11y.service: "mcp-python-refactoring"
      o11y.component: "mcp"
    logging:
      driver: "${O11Y_LOGGING_DRIVER:-json-file}"
      options:
        max-size: "${O11Y_LOG_MAX_SIZE:-10m}"
        max-file: "${O11Y_LOG_MAX_FILES:-3}"
        tag: '{{ "{{.Name}}" }}'

