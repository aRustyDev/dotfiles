# =============================================================================
# Typst MCP Server - Streamable HTTP
# =============================================================================
# AI-powered Typst markup language support. Enables AI assistants to convert
# LaTeX snippets to Typst, validate Typst syntax, render Typst to images,
# and browse Typst documentation.
#
# Build: docker build -f files/typst.dockerfile -t typst-mcp:http .
# Image: typst-mcp:http (wraps typst-mcp with supergateway)
#
# Usage in MCP clients (e.g., Zed):
#   {
#     "typst": {
#       "url": "https://tool.localhost/mcp",
#       "headers": {
#         "X-Service": "typst"
#       }
#     }
#   }
#
# Tools provided:
#   Documentation:
#     - list_docs_chapters: List all available Typst documentation chapters
#     - get_docs_chapter: Get content of a specific documentation chapter
#
#   Conversion:
#     - latex_snippet_to_typst: Convert LaTeX code snippets to Typst markup
#
#   Validation:
#     - check_if_snippet_is_valid_typst_syntax: Validate Typst code syntax
#
#   Rendering:
#     - typst_to_image: Render Typst markup to PNG image (base64 encoded)
#
# What is Typst?
#   Typst is a modern markup-based typesetting system designed as an
#   alternative to LaTeX. It offers faster compilation, more intuitive
#   syntax, and better error messages while maintaining professional
#   typesetting quality for academic papers, reports, and documents.
#
# Source: https://github.com/johannesbrandenburger/typst-mcp
# =============================================================================
---
services:
  typst:
    build:
      context: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/files
      dockerfile: typst.dockerfile
    image: typst-mcp:http
    container_name: typst
    profiles: ["core", "global", "docs", "writing"]
    restart: unless-stopped
    networks:
      - backend        # MCP backend services network
    expose:
      - "8080"
    environment:
      # Supergateway settings
      PORT: 8080
      MCP_PATH: /mcp
      SESSION_TIMEOUT: 120000
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('net').connect(8080, 'localhost').on('error', () => process.exit(1)).on('connect', () => process.exit(0))",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      # =======================================================================
      # Traefik Configuration - Streamable HTTP MCP
      # =======================================================================
      # NOTE: Routing is defined in file provider (svc.mcp.typst.yaml)
      # because parentRefs (multi-layer routing) is not supported in Docker labels.
      # =======================================================================
      traefik.enable: true
      traefik.docker.network: backend

networks:
  backend:
    external: true
