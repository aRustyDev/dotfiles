# =============================================================================
# Docker Hub MCP Server - Native Streamable HTTP
# =============================================================================
# Docker Hub API integration for searching images, viewing tags, and managing
# repositories. This server natively supports Streamable HTTP transport.
#
# Image: mcp/dockerhub (no wrapper needed - native HTTP support)
#
# Usage in MCP clients (e.g., Zed):
#   {
#     "dockerhub": {
#       "url": "https://tool.localhost/mcp",
#       "headers": {
#         "X-Service": "dockerhub"
#       }
#     }
#   }
#
# Tools provided:
#   - search: Search Docker Hub for images
#   - listRepositoriesByNamespace: List repositories in a namespace
#   - createRepository: Create a new repository
#   - getRepositoryInfo: Get repository information
#   - updateRepositoryInfo: Update repository details
#   - checkRepository: Check if a repository exists
#   - listRepositoryTags: List available tags for a repository
#   - getRepositoryTag: Get details about a specific tag
#   - checkRepositoryTag: Check if a tag exists
#   - listNamespaces: List available namespaces
#   - getPersonalNamespace: Get personal namespace info
#   - listAllNamespacesMemberOf: List namespaces user is member of
#   - dockerHardenedImages: Get Docker hardened images info
#
# Required environment:
#   - HUB_PAT_TOKEN: Docker Hub Personal Access Token
#   - --username: Docker Hub username (passed via command)
#
# Source: https://github.com/docker/hub-mcp
# Docker Hub: https://hub.docker.com/r/mcp/dockerhub
# =============================================================================
---
services:
  dockerhub:
    image: mcp/dockerhub
    container_name: dockerhub
    profiles: ["core", "docker"]
    restart: unless-stopped
    networks:
      - traefik-public
    ports:
      - "${DOCKERHUB_HTTP_PORT:-8215}:3000"
    command:
      - "--transport=http"
      - "--port=3000"
      - "--username=op://Developer/Docker-Hub-MCP/username"
    environment:
      HUB_PAT_TOKEN: "op://Developer/Docker-Hub-MCP/credential"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
        reservations:
          cpus: "0.1"
          memory: 64M
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('net').connect(3000, 'localhost').on('error', () => process.exit(1)).on('connect', () => process.exit(0))",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    labels:
      # =======================================================================
      # Traefik Configuration - Native Streamable HTTP MCP
      # =======================================================================
      # NOTE: Routing is defined in file provider (svc.mcp.dockerhub.yaml)
      # because parentRefs (multi-layer routing) is not supported in Docker labels.
      # =======================================================================
      traefik.enable: true
      traefik.docker.network: traefik-public
