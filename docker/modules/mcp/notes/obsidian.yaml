# =============================================================================
# Obsidian MCP Server - Streamable HTTP
# =============================================================================
# MCP server for interacting with Obsidian vaults via the Local REST API plugin.
# Provides tools for reading, searching, and modifying notes in your vault.
#
# Build: docker build -f files/obsidian.dockerfile -t obsidian-mcp:http .
# Image: obsidian-mcp:http (local build, wraps mcp-obsidian with supergateway)
#
# Prerequisites:
#   - Obsidian running with Local REST API plugin enabled
#   - Plugin: https://github.com/coddingtonbear/obsidian-local-rest-api
#   - API key from plugin settings
#
# Usage in MCP clients (e.g., Zed):
#   {
#     "obsidian": {
#       "url": "https://notes.localhost/mcp",
#       "headers": {
#         "X-Service": "obsidian"
#       }
#     }
#   }
#
# Tools provided:
#   - list_files_in_vault: Enumerate root directory contents
#   - list_files_in_dir: Browse specific directories
#   - get_file_contents: Retrieve individual file text
#   - search: Query across vault documents
#   - patch_content: Insert content relative to headings/blocks
#   - append_content: Add to new or existing files
#   - delete_file: Remove files or directories
#
# Required environment:
#   - OBSIDIAN_API_KEY: API key from Local REST API plugin (from 1Password)
#   - OBSIDIAN_HOST: Host where Obsidian is running (default: host.docker.internal)
#   - OBSIDIAN_PORT: Port for Local REST API (default: 27124)
#
# Source: https://github.com/MarkusPfundstein/mcp-obsidian
# =============================================================================
---
services:
  obsidian:
    build:
      context: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/files
      dockerfile: obsidian.dockerfile
    image: obsidian-mcp:http
    container_name: obsidian
    profiles: ["mcp-memory", "mcp"]
    restart: unless-stopped
    networks:
      - backend # MCP backend services network
    expose:
      - "8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      PORT: 8080
      MCP_PATH: /mcp
      SESSION_TIMEOUT: 60000
      # Obsidian Local REST API connection
      OBSIDIAN_API_KEY: "op://Developer/Obsidian/localhost/password"
      OBSIDIAN_HOST: "op://Developer/Obsidian/localhost/url"
      OBSIDIAN_PORT: 27124
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
        reservations:
          cpus: "0.1"
          memory: 64M
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('net').connect(8080, 'localhost').on('error', () => process.exit(1)).on('connect', () => process.exit(0))",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    labels:
      # =======================================================================
      # Traefik Configuration - Streamable HTTP MCP
      # =======================================================================
      # NOTE: Routing is defined in file provider (svc.mcp.obsidian.yaml)
      # because parentRefs (multi-layer routing) is not supported in Docker labels.
      # =======================================================================
      traefik.enable: true
      traefik.docker.network: backend
      # Observability labels
      o11y.service: "mcp-obsidian"
      o11y.component: "mcp"
    logging:
      driver: "${O11Y_LOGGING_DRIVER:-json-file}"
      options:
        max-size: "${O11Y_LOG_MAX_SIZE:-10m}"
        max-file: "${O11Y_LOG_MAX_FILES:-3}"
        tag: "{{.Name}}"

