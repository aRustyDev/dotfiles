# =============================================================================
# Meilisearch MCP Server - Streamable HTTP
# =============================================================================
# MCP server for interacting with Meilisearch search engine instances.
# Provides tools for searching, indexing, and managing Meilisearch data.
#
# Build: docker build -f files/meilisearch-mcp.dockerfile -t meilisearch-mcp:http .
# Image: meilisearch-mcp:http (local build, wraps getmeili/meilisearch-mcp with supergateway)
#
# Usage in MCP clients (e.g., Zed):
#   {
#     "meilisearch-mcp": {
#       "url": "https://tool.localhost/mcp",
#       "headers": {
#         "X-Service": "meilisearch-mcp"
#       }
#     }
#   }
#
# Tools provided:
#   - update-connection-settings: Connect to a Meilisearch instance
#   - get-version: Get Meilisearch version information
#   - health-check: Check Meilisearch instance health
#   - search: Search documents in an index
#   - get-document: Get a specific document by ID
#   - add-documents: Add documents to an index
#   - update-documents: Update existing documents
#   - delete-document: Delete a document by ID
#   - get-indexes: List all indexes
#   - create-index: Create a new index
#   - delete-index: Delete an index
#   - get-settings: Get index settings
#   - update-settings: Update index settings
#   - get-tasks: Get task status and history
#
# Required environment:
#   - MEILI_HTTP_ADDR: Meilisearch instance URL (e.g., http://meilisearch:7700)
#   - MEILI_MASTER_KEY: Meilisearch master/API key (from 1Password)
#
# Dependencies:
#   - Requires a running Meilisearch instance (see ../search/meilisearch.yaml)
#
# Source: https://github.com/meilisearch/meilisearch-mcp
# Docs: https://www.meilisearch.com/docs/guides/ai/mcp
# =============================================================================
---
services:
  meilisearch-mcp:
    build:
      context: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/files
      dockerfile: meilisearch-mcp.dockerfile
    image: meilisearch-mcp:http
    container_name: meilisearch-mcp
    profiles: ["core", "search"]
    restart: unless-stopped
    networks:
      - backend        # MCP backend services network
      - data-tier      # Access to Meilisearch database
    expose:
      - "8080"
    environment:
      PORT: 8080
      MCP_PATH: /mcp
      SESSION_TIMEOUT: 60000
      # Meilisearch connection settings
      MEILI_HTTP_ADDR: "http://surreal:7700"
      MEILI_MASTER_KEY: "op://Developer/Meilisearch/credential"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
        reservations:
          cpus: "0.1"
          memory: 64M
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('net').connect(8080, 'localhost').on('error', () => process.exit(1)).on('connect', () => process.exit(0))",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    labels:
      # =======================================================================
      # Traefik Configuration - Streamable HTTP MCP
      # =======================================================================
      # NOTE: Routing is defined in file provider (svc.mcp.meilisearch-mcp.yaml)
      # because parentRefs (multi-layer routing) is not supported in Docker labels.
      # =======================================================================
      traefik.enable: true
      traefik.docker.network: backend

networks:
  backend:
    external: true
  data-tier:
    external: true
