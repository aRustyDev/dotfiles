services:
  mcp-proxy:
    image: node:20-alpine
    container_name: thinking-http
    restart: unless-stopped
    command:
      - sh
      - -c
      - |
        apk add --no-cache docker-cli &&
        npm install -g mcp-proxy &&
        echo '#!/bin/sh' > /tmp/mcp-wrapper.sh &&
        echo 'exec docker exec -i thinking node dist/index.js' >> /tmp/mcp-wrapper.sh &&
        chmod +x /tmp/mcp-wrapper.sh &&
        exec mcp-proxy \
          --host=0.0.0.0 \
          --port=8080 \
          --stateless \
          --allow-origin "*" \
          /tmp/mcp-wrapper.sh
    expose:
      - "8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1",
        ]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - backend        # MCP backend services network
      - traefik-public # Legacy compatibility
    labels:
      # =======================================================================
      # Traefik Configuration - Streamable HTTP MCP
      # =======================================================================
      # NOTE: Routing is defined in file provider (svc.mcp.mcp-proxy.yaml)
      # because parentRefs (multi-layer routing) is not supported in Docker labels.
      # =======================================================================
      traefik.enable: true
      traefik.docker.network: backend
    depends_on:
      sequentialthinking:
        condition: service_healthy

networks:
  backend:
    external: true
  traefik-public:
    external: true
