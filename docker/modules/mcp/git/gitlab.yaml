# =============================================================================
# GitLab MCP Server - Streamable HTTP
# =============================================================================
# GitLab API integration for repository operations, issues, merge requests,
# pipelines, and CI/CD management.
#
# Build: docker build -f files/gitlab.dockerfile -t gitlab-mcp:http .
# Image: gitlab-mcp:http (local build, wraps mcp/gitlab with supergateway)
#
# Usage in MCP clients (e.g., Zed):
#   {
#     "gitlab": {
#       "url": "https://tool.localhost/mcp",
#       "headers": {
#         "X-Service": "gitlab"
#       }
#     }
#   }
#
# Tools provided:
#   - search_repositories: Search for GitLab projects
#   - get_project: Get project details
#   - list_branches: List branches in a project
#   - get_file_contents: Read file contents from a repository
#   - create_or_update_file: Create or update a file
#   - push_files: Push multiple files in a single commit
#   - create_branch: Create a new branch
#   - create_merge_request: Create a new merge request
#   - list_merge_requests: List merge requests
#   - get_merge_request: Get merge request details
#   - merge_merge_request: Merge a merge request
#   - create_issue: Create a new issue
#   - list_issues: List issues in a project
#   - get_issue: Get issue details
#   - update_issue: Update an existing issue
#   - add_issue_comment: Add comment to an issue
#   - list_pipelines: List CI/CD pipelines
#   - get_pipeline: Get pipeline details
#   - trigger_pipeline: Trigger a new pipeline
#
# Required environment:
#   - GITLAB_PERSONAL_ACCESS_TOKEN: GitLab PAT with api scope
#   - GITLAB_API_URL: (optional) GitLab API URL for self-hosted instances
#
# Source: https://github.com/modelcontextprotocol/servers/tree/main/src/gitlab
# Docker Hub: https://hub.docker.com/r/mcp/gitlab
# =============================================================================
---
services:
  gitlab:
    build:
      context: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/files
      dockerfile: gitlab.dockerfile
    image: gitlab-mcp:http
    container_name: gitlab
    profiles: ["core", "git", "gitlab", "repo"]
    restart: unless-stopped
    networks:
      - backend        # MCP backend services network
    expose:
      - "8080"
    environment:
      PORT: 8080
      MCP_PATH: /mcp
      SESSION_TIMEOUT: 60000
      GITLAB_PERSONAL_ACCESS_TOKEN: "op://Developer/zed-mcp-gitlab/credential"
      # GITLAB_API_URL: https://gitlab.example.com/api/v4  # For self-hosted
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('net').connect(8080, 'localhost').on('error', () => process.exit(1)).on('connect', () => process.exit(0))",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    labels:
      # =======================================================================
      # Traefik Configuration - Streamable HTTP MCP
      # =======================================================================
      # NOTE: Routing is defined in file provider (svc.mcp.gitlab.yaml)
      # because parentRefs (multi-layer routing) is not supported in Docker labels.
      # =======================================================================
      traefik.enable: true
      traefik.docker.network: backend

networks:
  backend:
    external: true
