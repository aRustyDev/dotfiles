# =============================================================================
# Workflows MCP Server - Streamable HTTP
# =============================================================================
# MCP server for YAML-based workflow orchestration. Allows AI agents to discover,
# understand, and execute complex, multi-step workflows defined in YAML files.
#
# Image: node:20-alpine with workflows-mcp-server (npm install)
#
# Usage in MCP clients (e.g., Zed):
#   {
#     "workflows": {
#       "url": "https://tool.localhost/mcp",
#       "headers": {
#         "X-Service": "workflows"
#       }
#     }
#   }
#
# Tools provided:
#   - workflow_return_list: Discover and list available workflows
#     Parameters: category?, tags?, includeTools?
#
#   - workflow_get_instructions: Retrieve complete workflow definition
#     Parameters: name, version?
#
#   - workflow_create_new: Create a new permanent workflow YAML file
#     Parameters: structured JSON object matching workflow schema
#
#   - workflow_create_temporary: Create temporary workflow (not listed)
#     Parameters: structured JSON object for multi-step plans
#
# Workflow directory:
#   Mount your workflow YAML files to /workflows:
#   - /workflows/category1/workflow1.yaml
#   - /workflows/category2/workflow2.yaml
#
# Source: https://github.com/cyanheads/workflows-mcp-server
# =============================================================================
---
services:
  workflows:
    image: node:20-alpine
    container_name: workflows
    profiles: ["core", "workflow", "orchestration"]
    restart: unless-stopped
    working_dir: /app
    command:
      - sh
      - -c
      - |
        npm install -g workflows-mcp-server &&
        exec workflows-mcp-server
    networks:
      - traefik-public
    expose:
      - "3010"
    volumes:
      # Workflow YAML definitions
      - ${XDG_CONFIG_HOME:-$HOME/.config}/mcp/workflows:/workflows
      # Logs directory
      - ${XDG_DATA_HOME:-$HOME/.local/share}/mcp/workflows/logs:/app/logs
    environment:
      # Transport configuration
      MCP_TRANSPORT_TYPE: http
      MCP_HTTP_HOST: 0.0.0.0
      MCP_HTTP_PORT: 3010

      # Logging
      MCP_LOG_LEVEL: "${WORKFLOWS_LOG_LEVEL:-info}"
      LOGS_DIR: /app/logs

      # CORS - allow all origins for MCP routing
      MCP_ALLOWED_ORIGINS: "*"

      # Authentication (optional - set in .env for production)
      # MCP_AUTH_MODE: jwt
      # MCP_AUTH_SECRET_KEY: "${WORKFLOWS_AUTH_SECRET:-}"

      # Node environment
      NODE_ENV: production
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:3010/health || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      # =======================================================================
      # Traefik Configuration - Streamable HTTP MCP
      # =======================================================================
      # NOTE: Routing is defined in file provider (svc.mcp.workflows.yaml)
      # because parentRefs (multi-layer routing) is not supported in Docker labels.
      # =======================================================================
      traefik.enable: true
      traefik.docker.network: traefik-public

networks:
  traefik-public:
    external: true
