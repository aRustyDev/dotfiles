# =============================================================================
# Todoist MCP Server - Streamable HTTP
# =============================================================================
# MCP server for Todoist integration enabling natural language task management.
# Create, update, complete, and delete tasks using everyday language.
#
# Build: docker build -f files/todoist.dockerfile -t todoist-mcp:http .
# Image: todoist-mcp:http (wraps @abhiz123/todoist-mcp-server with supergateway)
#
# Usage in MCP clients (e.g., Zed):
#   {
#     "todoist": {
#       "url": "https://tool.localhost/mcp",
#       "headers": {
#         "X-Service": "todoist"
#       }
#     }
#   }
#
# Tools provided:
#   - todoist_create_task: Create new tasks with content, description, due date, priority
#     Example: "Create task 'Team Meeting' due tomorrow"
#
#   - todoist_get_tasks: Retrieve and filter tasks by due date, priority, project
#     Example: "Show high priority tasks due this week"
#
#   - todoist_update_task: Update existing tasks using natural language search
#     Example: "Update meeting task to be due next Monday"
#
#   - todoist_complete_task: Mark tasks as complete using natural language search
#     Example: "Mark the documentation task as complete"
#
#   - todoist_delete_task: Remove tasks using natural language search
#     Example: "Delete the PR review task"
#
# API Token:
#   1. Log in to Todoist
#   2. Navigate to Settings -> Integrations
#   3. Find API token under "Developer"
#
# Source: https://github.com/abhiz123/todoist-mcp-server
# =============================================================================
---
services:
  todoist:
    build:
      context: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/files
      dockerfile: todoist.dockerfile
    image: todoist-mcp:http
    container_name: todoist
    profiles: ["core", "workflow", "productivity"]
    restart: unless-stopped
    networks:
      - traefik-public
    ports:
      - "${TODOIST_MCP_HTTP_PORT:-8227}:8080"
    environment:
      # Supergateway settings
      PORT: 8080
      MCP_PATH: /mcp
      SESSION_TIMEOUT: 60000

      # Todoist API Token (required)
      # Get from: Todoist Settings -> Integrations -> Developer
      TODOIST_API_TOKEN: "${TODOIST_API_TOKEN:-op://Developer/Todoist/api-token}"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('net').connect(8080, 'localhost').on('error', () => process.exit(1)).on('connect', () => process.exit(0))",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    labels:
      # =======================================================================
      # Traefik Configuration - Streamable HTTP MCP
      # =======================================================================
      # NOTE: Routing is defined in file provider (svc.mcp.todoist.yaml)
      # because parentRefs (multi-layer routing) is not supported in Docker labels.
      # =======================================================================
      traefik.enable: true
      traefik.docker.network: traefik-public

networks:
  traefik-public:
    external: true
