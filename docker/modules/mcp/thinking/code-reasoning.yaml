# =============================================================================
# Code Reasoning MCP Server - Streamable HTTP
# =============================================================================
# MCP server for structured, step-by-step reasoning on programming tasks.
# Fork of Anthropic's sequential-thinking optimized for coding contexts.
#
# Build: docker build -f files/code-reasoning.dockerfile -t code-reasoning-mcp:http .
# Image: code-reasoning-mcp:http (local build, wraps code-reasoning with supergateway)
#
# Usage in MCP clients (e.g., Zed):
#   {
#     "code-reasoning": {
#       "url": "https://tool.localhost/mcp",
#       "headers": {
#         "X-Service": "code-reasoning"
#       }
#     }
#   }
#
# Tools provided:
#   - code_reasoning: Structured thinking for programming tasks
#     Parameters:
#       - thought (required): Current thinking step
#       - nextThoughtNeeded (required): Whether another step is needed
#       - thoughtNumber (required): Current step number
#       - totalThoughts (required): Estimated total steps
#       - isRevision (optional): Whether revising previous thinking
#       - revisesThought (optional): Which thought is being revised
#       - branchFromThought (optional): Branching point for parallel exploration
#       - branchId (optional): Identifier for current branch
#       - needsMoreThoughts (optional): If more thoughts needed at end
#
# Key Features:
#   - Programming-focused prompts and reasoning patterns
#   - Thought branching for exploring multiple solutions
#   - Thought revision for refining understanding
#   - Safety limits (20 thought steps max)
#   - Pre-defined prompt templates for common dev tasks
#
# Source: https://github.com/mettamatt/code-reasoning
# =============================================================================
---
services:
  code-reasoning:
    build:
      context: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/files
      dockerfile: code-reasoning.dockerfile
    image: code-reasoning-mcp:http
    container_name: code-reasoning
    hostname: code-reasoning
    profiles: ["core", "thinking", "dev"]
    restart: unless-stopped
    networks:
      - backend        # MCP backend services network
    expose:
      - "8080"
    environment:
      PORT: 8080
      MCP_PATH: /mcp
      SESSION_TIMEOUT: 60000
      NODE_ENV: production
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('net').connect(8080, 'localhost').on('error', () => process.exit(1)).on('connect', () => process.exit(0))",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    labels:
      # =======================================================================
      # Traefik Configuration - Streamable HTTP MCP
      # =======================================================================
      # NOTE: Routing is defined in file provider (svc.mcp.code-reasoning.yaml)
      # because parentRefs (multi-layer routing) is not supported in Docker labels.
      # =======================================================================
      traefik.enable: true
      traefik.docker.network: backend

