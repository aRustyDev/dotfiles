---
# =============================================================================
# Prometheus - Metrics Collection & Monitoring
# =============================================================================
#
# Prometheus is an open-source systems monitoring and alerting toolkit.
# It collects and stores metrics as time series data, with support for
# multi-dimensional data collection and querying via PromQL.
#
# Features:
#   - Pull-based metrics collection
#   - PromQL query language
#   - Service discovery (Docker, Kubernetes, etc.)
#   - Alerting via Alertmanager
#   - Efficient time-series storage
#   - Remote write to Mimir/Cortex for long-term storage
#
# Endpoints:
#   - Web UI: http://localhost:9090
#   - API: /api/v1/*
#   - Metrics: /metrics
#   - Health: /-/healthy
#   - Ready: /-/ready
#
# Configuration:
#   - Main config: prometheus.yml
#   - Alerting rules: rules/*.yml
#   - Recording rules: rules/*.yml
#
# Usage:
#   docker-compose -f prometheus.yaml up
#   docker-compose --profile observability up
#
# =============================================================================

services:
  prometheus:
    image: prom/prometheus:v2.52.0
    hostname: prometheus
    container_name: prometheus
    profiles: ["o11y-metrics", "o11y"]
    user: "65534:65534"
    networks:
      - backend       # For scraping targets and writing to Mimir
      - admin         # For admin UI access
      - data-tier     # For remote_write to Mimir
    restart: unless-stopped
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --storage.tsdb.retention.time=15d
      - --storage.tsdb.retention.size=10GB
      - --web.console.libraries=/usr/share/prometheus/console_libraries
      - --web.console.templates=/usr/share/prometheus/consoles
      - --web.enable-lifecycle
      - --web.enable-admin-api
      - --enable-feature=exemplar-storage
      - --enable-feature=native-histograms
    volumes:
      - ${XDG_CONFIG_HOME:-$HOME/.config}/docker/config/prometheus:/etc/prometheus:ro
      - ${XDG_DATA_HOME:-$HOME/.local/share}/prometheus:/prometheus
      - /var/run/docker.sock:/var/run/docker.sock:ro
    expose:
      - "9090"
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:9090/-/healthy || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M
