---
# =============================================================================
# Grafana Beyla - eBPF Auto-Instrumentation
# =============================================================================
#
# Beyla is an eBPF-based auto-instrumentation tool that generates application
# telemetry (traces and metrics) without requiring code changes. It uses eBPF
# to hook into system calls and extract observability data.
#
# Features:
#   - Zero-code instrumentation
#   - Automatic service detection
#   - HTTP/gRPC request tracing
#   - RED metrics generation (Rate, Errors, Duration)
#   - Go, Java, Python, Node.js, Rust, Ruby support
#   - Kubernetes metadata enrichment
#   - OTLP export to Tempo/Grafana Cloud
#
# Requirements:
#   - Linux kernel 5.8+ (for BPF ring buffers)
#   - CAP_SYS_ADMIN or privileged mode
#   - BTF (BPF Type Format) enabled kernel
#
# Supported Protocols:
#   - HTTP/1.1
#   - HTTP/2 (gRPC)
#   - SQL (MySQL, PostgreSQL)
#   - Redis
#   - Kafka
#
# Usage:
#   docker-compose -f beyla.yaml up
#   docker-compose --profile observability up
#
# Note: Requires privileged mode or specific capabilities for eBPF
#
# =============================================================================

services:
  beyla:
    image: grafana/beyla:1.6.0
    hostname: beyla
    container_name: beyla
    profiles: ["o11y-profiling", "o11y"]
    privileged: true  # Required for eBPF
    pid: "host"       # Required to see other processes
    networks:
      - backend       # For exporting telemetry
    restart: unless-stopped
    environment:
      # Discovery - which processes to instrument
      BEYLA_DISCOVERY_SERVICES: ".*"  # Instrument all services
      # BEYLA_OPEN_PORT: "80,443,8080,3000,5000"  # Or by ports
      # BEYLA_EXECUTABLE_NAME: "nginx|python|node"  # Or by process name

      # OTLP Export configuration
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://tempo:4318"
      OTEL_EXPORTER_OTLP_PROTOCOL: "http/protobuf"

      # Prometheus metrics export
      BEYLA_PROMETHEUS_PORT: "9090"

      # Internal metrics
      BEYLA_INTERNAL_METRICS_PROMETHEUS_PORT: "6060"

      # Logging
      BEYLA_LOG_LEVEL: "INFO"

      # Service name (if not auto-detected)
      OTEL_SERVICE_NAME: "beyla-instrumented"
    volumes:
      # Required for eBPF
      - /sys/kernel/security:/sys/kernel/security:ro
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
    expose:
      - "9090"   # Prometheus metrics
      - "6060"   # Internal metrics
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:6060/metrics || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
