---
# =============================================================================
# Grafana Beyla - eBPF Auto-Instrumentation
# =============================================================================
#
# Beyla is an eBPF-based auto-instrumentation tool that generates application
# telemetry (traces and metrics) without requiring code changes. It uses eBPF
# to hook into system calls and extract observability data.
#
# Features:
#   - Zero-code instrumentation
#   - Automatic service detection
#   - HTTP/gRPC request tracing
#   - RED metrics generation (Rate, Errors, Duration)
#   - Go, Java, Python, Node.js, Rust, Ruby support
#   - Kubernetes metadata enrichment
#   - OTLP export to Tempo/Grafana Cloud
#
# Requirements:
#   - Linux kernel 5.8+ (for BPF ring buffers)
#   - CAP_SYS_ADMIN or privileged mode
#   - BTF (BPF Type Format) enabled kernel
#
# Supported Protocols:
#   - HTTP/1.1
#   - HTTP/2 (gRPC)
#   - SQL (MySQL, PostgreSQL)
#   - Redis
#   - Kafka
#
# Usage:
#   docker-compose -f beyla.yaml up
#   docker-compose --profile observability up
#
# Note: Requires privileged mode or specific capabilities for eBPF
#
# =============================================================================

services:
  beyla:
    image: grafana/beyla:1.6.0
    hostname: beyla
    container_name: beyla
    profiles: ["o11y-auto", "o11y"]
    privileged: true  # Required for eBPF
    pid: "host"       # Required to see other processes
    networks:
      - backend       # For exporting telemetry
      - data-tier     # For accessing backends
    restart: unless-stopped
    command:
      - --config=/etc/beyla/config.yaml
    environment:
      # =======================================================================
      # Observability Toggles
      # =======================================================================
      # Tracing - export to Tempo
      OTEL_EXPORTER_OTLP_ENDPOINT: "${OTEL_EXPORTER_OTLP_ENDPOINT:-http://tempo:4317}"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_TRACES_EXPORTER: "${O11Y_TRACING_ENABLED:-otlp}"
      # Metrics - export to OTEL Collector -> Mimir
      OTEL_METRICS_EXPORTER: "${O11Y_METRICS_ENABLED:-otlp}"
      # Service identification
      OTEL_SERVICE_NAMESPACE: "${BEYLA_SERVICE_NAMESPACE:-homelab}"
      OTEL_RESOURCE_ATTRIBUTES: "deployment.environment=${ENVIRONMENT:-development}"
      # Logging
      BEYLA_LOG_LEVEL: "${BEYLA_LOG_LEVEL:-INFO}"
    volumes:
      # Configuration file
      - ${XDG_CONFIG_HOME:-$HOME/.config}/docker/config/beyla:/etc/beyla:ro
      # Required for eBPF
      - /sys/kernel/security:/sys/kernel/security:ro
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
    expose:
      - "9400"   # Prometheus metrics (application)
      - "6060"   # Internal metrics (beyla self)
    labels:
      # Prometheus scraping for Beyla-generated metrics
      prometheus.scrape: "${O11Y_METRICS_ENABLED:-true}"
      prometheus.port: "9400"
      prometheus.path: "/metrics"
      o11y.service: "beyla"
    logging:
      driver: "${O11Y_LOGGING_DRIVER:-json-file}"
      options:
        max-size: "${O11Y_LOG_MAX_SIZE:-10m}"
        max-file: "${O11Y_LOG_MAX_FILES:-3}"
        tag: '{{ "{{.Name}}" }}'
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:6060/metrics || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
