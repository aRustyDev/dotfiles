---
# =============================================================================
# Grafana Mimir - Scalable Long-Term Metrics Storage
# =============================================================================
#
# Mimir is an open-source, horizontally scalable, highly available, multi-tenant
# TSDB for long-term storage of Prometheus metrics. It provides a Prometheus-
# compatible query API with improved scalability.
#
# Features:
#   - Horizontally scalable (handles billions of active series)
#   - 100% Prometheus-compatible (remote_write & PromQL)
#   - Multi-tenant by design
#   - Long-term storage with compaction
#   - High availability with replication
#   - Native Grafana integration
#
# API Compatibility:
#   - Remote Write: /api/v1/push
#   - Query: /prometheus/api/v1/query
#   - Query Range: /prometheus/api/v1/query_range
#   - Series: /prometheus/api/v1/series
#   - Labels: /prometheus/api/v1/labels
#
# Usage:
#   docker-compose -f mimir.yaml up
#   docker-compose --profile observability up
#
# =============================================================================

services:
  mimir:
    image: grafana/mimir:2.12.0
    hostname: mimir
    container_name: mimir
    profiles: ["observability", "lgtm", "metrics"]
    user: "10001:10001"
    networks:
      - backend       # For service access
      - data-tier     # For storage backends
    restart: unless-stopped
    command:
      - -config.file=/etc/mimir/mimir.yaml
      - -target=all
    volumes:
      - ${XDG_CONFIG_HOME:-$HOME/.config}/docker/config/mimir:/etc/mimir:ro
      - ${XDG_DATA_HOME:-$HOME/.local/share}/mimir:/data
    expose:
      - "9009"   # HTTP API
      - "9095"   # gRPC
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:9009/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    labels:
      traefik.enable: true
      traefik.docker.network: backend
      traefik.http.routers.mimir.rule: Host(`mimir.localhost`)
      traefik.http.routers.mimir.entrypoints: websecure
      traefik.http.routers.mimir.tls: true
      traefik.http.services.mimir.loadbalancer.server.port: 9009
