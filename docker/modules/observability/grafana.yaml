---
# =============================================================================
# Grafana - Observability & Visualization Platform
# =============================================================================
#
# Grafana is the open-source platform for monitoring and observability.
# It allows you to query, visualize, alert on, and understand your metrics
# no matter where they are stored.
#
# Features:
#   - Unified dashboards for metrics, logs, and traces
#   - Native support for Prometheus, Loki, Tempo, Mimir
#   - Alerting with multiple notification channels
#   - Data source plugins for 100+ backends
#   - Dashboard provisioning via YAML
#
# Default Credentials:
#   - Username: admin
#   - Password: (set via GF_SECURITY_ADMIN_PASSWORD)
#
# Pre-configured Data Sources:
#   - Prometheus (metrics)
#   - Loki (logs)
#   - Tempo (traces)
#   - Mimir (long-term metrics)
#   - Pyroscope (continuous profiling)
#
# Usage:
#   docker-compose -f grafana.yaml up
#   docker-compose --profile observability up
#
# =============================================================================

services:
  grafana:
    image: grafana/grafana:11.0.0
    hostname: grafana
    container_name: grafana
    profiles: ["core", "o11y"]
    user: "472:472"
    networks:
      - frontend # Web UI access
      - backend # Connect to data sources
    restart: unless-stopped
    environment:
      # Security
      GF_SECURITY_ADMIN_USER: "${GRAFANA_ADMIN_USER:-op://Developer/Grafana/Admin/user}"
      GF_SECURITY_ADMIN_PASSWORD: "${GRAFANA_ADMIN_PASSWORD:-op://Developer/Grafana/Admin/password}"
      GF_USERS_ALLOW_SIGN_UP: "false"
      # Server
      GF_SERVER_ROOT_URL: "https://grafana.localhost"
      GF_SERVER_DOMAIN: "grafana.localhost"
      # Auth
      GF_AUTH_ANONYMOUS_ENABLED: "false"
      # Paths
      GF_PATHS_PROVISIONING: "/etc/grafana/provisioning"
      # Feature toggles
      GF_FEATURE_TOGGLES_ENABLE: "traceqlEditor tempoSearch tempoBackendSearch tempoApmTable traceToProfiles tracesEmbeddedFlameGraph"
      # Plugins
      GF_INSTALL_PLUGINS: "grafana-clock-panel,grafana-simple-json-datasource,grafana-piechart-panel"
    volumes:
      - ${XDG_CONFIG_HOME:-$HOME/.config}/docker/config/grafana/provisioning:/etc/grafana/provisioning:ro
      - ${XDG_DATA_HOME:-$HOME/.local/share}/grafana:/var/lib/grafana
    expose:
      - "3000"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --spider -q http://localhost:3000/api/health || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
