services:
  ingress:
    image: traefik:v3.2
    container_name: ingress
    security_opt:
      - no-new-privileges:true
    networks:
      - traefik-public
    command:
      - "--api.insecure=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedByDefault=false"
      - "--providers.file.filename=/etc/traefik/config.yaml"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--ping.entrypoint=web"
    ports:
      - "80:80" # HTTP
      - "443:443" # HTTPS
    configs:
      - source: traefik
        target: /etc/traefik/config.yaml
        mode: 0440
    volumes:
      # Docker socket (read-only for security)
      - /var/run/docker.sock:/var/run/docker.sock:ro

      # Dynamic configurations (file provider)
      - ${XDG_CONFIG_HOME:-$HOME/.config}/docker/config/traefik/dynamic:/etc/traefik/dynamic:ro

      # TLS certificates (mkcert)
      - ${XDG_DATA_HOME:-$HOME/.local/share}/traefik/certs:/etc/traefik/certs:ro

      # Certificate storage (Let's Encrypt)
      - ${XDG_DATA_HOME:-$HOME/.local/share}/traefik/acme:/etc/traefik/acme

      # Logs
      - ${XDG_DATA_HOME:-$HOME/.local/share}/traefik/logs:/var/log/traefik
    environment:
      - TZ=America/New_York
    labels:
      # Enable Traefik
      traefik.enable: true
      # Dashboard Access via HTTPS
      traefik.http.routers.dashboard.rule: Host(`traefik.localhost`)
      traefik.http.routers.dashboard.service: api@internal
      traefik.http.routers.dashboard.entrypoints: websecure
      traefik.http.routers.dashboard.tls: true
      traefik.http.routers.dashboard.parentRefs[0]: api@file
      # Apply middleware to dashboard
      # traefik.http.routers.dashboard.middlewares: auth-basic@file,secure-headers@file
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 128M
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  traefik-public:

configs:
  traefik:
    file: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/config/traefik.yaml
