services:
  ingress:
    image: traefik:v3.6
    container_name: ingress
    security_opt:
      - no-new-privileges:true
    networks:
      # Traefik must be connected to all networks it routes to
      - dmz            # Primary ingress network
      - frontend       # Route to frontend services (UIs, dashboards)
      - backend        # Route to backend services (MCP, APIs)
      - admin          # Route to admin interfaces
      - data-tier      # Route to database UIs (optional)
      - authn          # Route to authentication services
      - authz          # Route to authorization services
    command:
      - "--configFile=/etc/traefik/traefik.yaml"
    ports:
      - "80:80" # HTTP
      - "443:443" # HTTPS
    configs:
      - source: traefik
        target: /etc/traefik/traefik.yaml
        mode: 0440
    volumes:
      # Docker socket (read-only for security)
      - /var/run/docker.sock:/var/run/docker.sock:ro

      # Dynamic configurations (file provider)
      - ${XDG_CONFIG_HOME:-$HOME/.config}/docker/config/traefik/dynamic:/etc/traefik/dynamic:ro

      # TLS certificates (mkcert)
      - ${XDG_CONFIG_HOME:-$HOME/.config}/docker/data/certs:/etc/traefik/certs:ro

      # Certificate storage (Let's Encrypt)
      - ${XDG_DATA_HOME:-$HOME/.local/share}/traefik/acme:/etc/traefik/acme

      # Logs
      - ${XDG_DATA_HOME:-$HOME/.local/share}/traefik/logs:/var/log/traefik
    environment:
      - TZ=America/New_York
    expose:
      - "8080"  # Metrics endpoint (internal)
    labels:
      # Enable Traefik
      traefik.enable: true
      # Dashboard Access via HTTPS
      traefik.http.routers.dashboard.rule: Host(`traefik.localhost`)
      traefik.http.routers.dashboard.service: api@internal
      traefik.http.routers.dashboard.entrypoints: websecure
      traefik.http.routers.dashboard.tls: true
      # Apply middleware to dashboard
      # traefik.http.routers.dashboard.middlewares: auth-basic@file,secure-headers@file
      # =======================================================================
      # Prometheus Scraping
      # =======================================================================
      prometheus.scrape: "${O11Y_METRICS_ENABLED:-true}"
      prometheus.port: "8080"
      prometheus.path: "/metrics"
      o11y.service: "traefik"
    logging:
      driver: "${O11Y_LOGGING_DRIVER:-json-file}"
      options:
        max-size: "${O11Y_LOG_MAX_SIZE:-10m}"
        max-file: "${O11Y_LOG_MAX_FILES:-3}"
        tag: '{{ "{{.Name}}" }}'
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 128M
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s


configs:
  traefik:
    file: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/config/traefik/traefik.yaml
