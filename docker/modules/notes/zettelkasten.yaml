---
# NOTE: Server is not HTTP capable yet; requires extension
services:
  zettelkasten:
    image: ghcr.io/arustydev/zettelkasten-mcp:latest
    container_name: zettelkasten
    profiles: ["core"]
    restart: unless-stopped
    stdin_open: true # docker run -i
    tty: true # docker run -t
    networks:
      - traefik-public
    ports:
      - "${ZETTELKASTEN_HTTP_PORT:-8200}:8000"
    volumes:
      # Persistent storage for notes and database
      - ${XDG_DATA_HOME:-$HOME/.local/share}/mcp/zettelkasten/notes:/var/data/notes
      - ${XDG_DATA_HOME:-$HOME/.local/share}/mcp/zettelkasten/db:/var/data/db
    command:
      - "--transport"
      - "http"
      - "--host"
      - "0.0.0.0"
      - "--port"
      - "8000"
      - "--notes-dir"
      - "/var/data/notes"
      - "--database-path"
      - "/var/data/db/zettelkasten.db"
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/health').read()",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    environment:
      ZETTELKASTEN_LOG_LEVEL: INFO
      ZETTELKASTEN_HTTP_HOST: 0.0.0.0
      ZETTELKASTEN_HTTP_PORT: 8000
      ZETTELKASTEN_HTTP_CORS: false
      ZETTELKASTEN_HTTP_CORS_ORIGINS: "*"
      ZETTELKASTEN_JSON_RESPONSE: true
    labels:
      # Streamable HTTP routing for MCP
      # Enable Traefik
      traefik.enable: true
      traefik.http.services.zettelkasten.loadbalancer.server.port: 8000
      # Primary route: /mcp endpoint (Streamable HTTP)
      traefik.http.routers.zettelkasten.rule: Header(`X-Service`, `zettelkasten`)
      traefik.http.routers.zettelkasten.service: zettelkasten
      traefik.http.routers.zettelkasten.entrypoints: websecure
      traefik.http.routers.zettelkasten.tls: true
      traefik.http.routers.zettelkasten.parentRefs[0]: notes@file
      traefik.http.routers.zettelkasten.parentRefs[1]: mcp@file
      # Health check endpoint
      traefik.http.routers.zettelkasten-health.rule: Header(`X-Service`, `zettelkasten`)
      traefik.http.routers.zettelkasten-health.service: zettelkasten
      traefik.http.routers.zettelkasten-health.entrypoints: websecure
      traefik.http.routers.zettelkasten-health.tls: true
      traefik.http.routers.zettelkasten-health.parentRefs[0]: notes@file
      traefik.http.routers.zettelkasten-health.parentRefs[1]: health@file
      # Specify network (if container is on multiple networks)
      traefik.docker.network: traefik-public
