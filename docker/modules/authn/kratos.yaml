---
# =============================================================================
# ORY Kratos Docker Compose Configuration
# =============================================================================
#
# ORY Kratos is an identity and user management system. It handles
# registration, login, account recovery, MFA, and user profile management.
#
# Components:
#   - kratos: Identity server
#   - kratos-migrate: Database migration job
#   - mailslurper: Development email server (dev profile only)
#
# Endpoints:
#   - Public API: port 4433 (self-service flows)
#   - Admin API: port 4434 (identity management)
#
# Environment Variables:
#   KRATOS_DSN                     - Database connection string
#   KRATOS_SECRETS_DEFAULT         - Default encryption secret
#   KRATOS_SECRETS_COOKIE          - Cookie encryption secret
#   KRATOS_COURIER_SMTP_CONNECTION - SMTP connection string
#
# Identity Schemas:
#   - Stored in ${XDG_CONFIG_HOME}/docker/config/ory/kratos/schemas/
#
# Usage:
#   docker-compose -f kratos.yaml up
#   docker-compose -f kratos.yaml --profile dev up  # includes mailslurper
#
# =============================================================================

services:
  # Kratos Migration Job
  kratos-migrate:
    image: oryd/kratos:v1.3.1
    container_name: kratos-migrate
    profiles: ["core"]
    networks:
      - authn
      - data-tier # Access to PostgreSQL
    depends_on:
      postgres:
        condition: service_healthy
    command: migrate sql -e --yes
    environment:
      DSN: "${KRATOS_DSN:-postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${KRATOS_DB:-kratos}?sslmode=disable}"
    restart: on-failure

  # ORY Kratos Identity Server
  kratos:
    image: oryd/kratos:v1.3.1
    container_name: kratos
    hostname: kratos
    profiles: ["core"]
    restart: unless-stopped
    stdin_open: true
    tty: true
    networks:
      - authn # Authentication network
      - data-tier # Access to PostgreSQL
    depends_on:
      kratos-migrate:
        condition: service_completed_successfully
    command: serve all -c /etc/kratos/kratos.yaml --watch-courier
    configs:
      - source: kratos
        target: /etc/kratos/kratos.yaml
        mode: 0440
      - source: kratos-identity-schema
        target: /etc/kratos/schemas/identity.schema.json
        mode: 0440
    environment:
      # Database configuration
      DSN: "${KRATOS_DSN:-postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${KRATOS_DB:-kratos}?sslmode=disable}"
      # Secrets (generate with: openssl rand -hex 32)
      SECRETS_DEFAULT: "${KRATOS_SECRETS_DEFAULT:-op://Developer/ORY/kratos/secrets-default}"
      SECRETS_COOKIE: "${KRATOS_SECRETS_COOKIE:-op://Developer/ORY/kratos/secrets-cookie}"
      # URLs
      SERVE_PUBLIC_BASE_URL: "${KRATOS_PUBLIC_URL:-https://id.localhost}"
      SERVE_ADMIN_BASE_URL: "${KRATOS_ADMIN_URL:-http://kratos:4434}"
      # SMTP (for dev, use mailslurper; for prod, configure real SMTP)
      COURIER_SMTP_CONNECTION_URI: "${KRATOS_COURIER_SMTP:-smtps://test:test@mailslurper:1025/?skip_ssl_verify=true}"
      # Logging
      LOG_LEVEL: "${KRATOS_LOG_LEVEL:-info}"
      LOG_FORMAT: "json"
      LOG_LEAK_SENSITIVE_VALUES: "false"
      # =======================================================================
      # Observability - Tracing (OpenTelemetry)
      # =======================================================================
      TRACING_PROVIDER: "${KRATOS_TRACING_PROVIDER:-${O11Y_TRACING_ENABLED:+otel}}"
      TRACING_PROVIDERS_OTLP_ENDPOINT: "${OTEL_EXPORTER_OTLP_ENDPOINT:-otel-collector:4317}"
      TRACING_PROVIDERS_OTLP_INSECURE: "true"
      TRACING_SERVICE_NAME: "kratos"
      TRACING_PROVIDERS_OTLP_SAMPLING_SAMPLING_RATIO: "${KRATOS_TRACING_SAMPLE_RATE:-0.1}"
    expose:
      - "4433" # Public API
      - "4434" # Admin API
    labels:
      # =======================================================================
      # Traefik Configuration - ORY Kratos Identity
      # =======================================================================
      # NOTE: Routing is defined in file provider (svc.authn.kratos.yaml)
      # because parentRefs (multi-layer routing) is not supported in Docker labels.
      #
      # Endpoints:
      #   - Public API: https://id.localhost/self-service/...
      #   - Admin API: Internal only
      # =======================================================================
      traefik.enable: true
      traefik.docker.network: authn
      # Prometheus scraping
      prometheus.scrape: "${O11Y_METRICS_ENABLED:-true}"
      prometheus.port: "4434"
      prometheus.path: "/admin/metrics/prometheus"
      o11y.service: "kratos"
    logging:
      driver: "${O11Y_LOGGING_DRIVER:-json-file}"
      options:
        max-size: "${O11Y_LOG_MAX_SIZE:-10m}"
        max-file: "${O11Y_LOG_MAX_FILES:-3}"
        tag: '{{ "{{.Name}}" }}'
    # Resource Tier 2: Light (Identity management with crypto)
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:4433/health/ready",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Development Email Server
  mailslurper:
    image: oryd/mailslurper:latest-smtps
    container_name: mailslurper
    profiles: ["core"]
    networks:
      - authn # Authentication network
    expose:
      - "1025" # SMTP
      - "4436" # API
      - "4437" # Web UI
    labels:
      traefik.enable: true
      traefik.docker.network: authn
      traefik.http.routers.mailslurper.rule: Host(`mail.localhost`)
      traefik.http.routers.mailslurper.entrypoints: websecure
      traefik.http.routers.mailslurper.tls: true
      traefik.http.services.mailslurper.loadbalancer.server.port: 4437

configs:
  kratos:
    file: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/config/ory/kratos/kratos.yaml
  kratos-identity-schema:
    file: ${XDG_CONFIG_HOME:-$HOME/.config}/docker/config/ory/kratos/schemas/identity.schema.json
